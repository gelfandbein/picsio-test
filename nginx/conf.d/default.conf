###
# +	rewrite /api/(.*) /$1 break;
# +	portainer

#####################################
##################################### UPSTREAMs
#####################################
#upstream kibana {
#    server kibana:5601/app/kibana;
#    keepalive 15;
#}

#upstream es01 {
#    server es01:9200;
#    keepalive 15;
#}

#upstream es02 {
#    server es02:9200;
#    keepalive 15;
#}

upstream portainer {
    server portainer:9000;
}



server {
    listen 80;
    # listen [::]:80 default_server;
    # resolver 127.0.0.11;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    location = /nginx_status {
	stub_status on;
	access_log off;
	allow 127.0.0.1;
	allow 172.16.0.0/12;
	deny all;
    }

    # location / {
    #	try_files $uri $uri/ =404;
    # }

    location /top {
      # auth_basic "Restricted Access";
      # auth_basic_user_file /etc/nginx/htpasswd.elk;
      proxy_pass http://localhost:12345/top;
      proxy_redirect off;
      proxy_buffering off;
      proxy_http_version 1.1;
      proxy_set_header Connection "Keep-Alive";
      proxy_set_header Proxy-Connection "Keep-Alive";
    }

    location /logstash {
      # auth_basic "Restricted Access";
      # auth_basic_user_file /etc/nginx/htpasswd.elk;
      proxy_pass http://logstash:9600/;
      proxy_redirect off;
      proxy_buffering off;
      proxy_http_version 1.1;
      proxy_set_header Connection "Keep-Alive";
      proxy_set_header Proxy-Connection "Keep-Alive";
    }

    location /elasticsearch {
      # auth_basic "Restricted Access";
      # auth_basic_user_file /etc/nginx/htpasswd.elk;
      proxy_pass http://elasticsearch:9200/;
      proxy_redirect off;
      proxy_buffering off;
      proxy_http_version 1.1;
      proxy_set_header Connection "Keep-Alive";
      proxy_set_header Proxy-Connection "Keep-Alive";
    }

#    location /es02 {
#      auth_basic "Restricted Access";
#      auth_basic_user_file /etc/nginx/htpasswd.elk;
#      proxy_pass http://es02:9200/;
#      proxy_redirect off;
#      proxy_buffering off;
#      proxy_http_version 1.1;
#      proxy_set_header Connection "Keep-Alive";
#      proxy_set_header Proxy-Connection "Keep-Alive";
#    }

#    location /es03 {
#      auth_basic "Restricted Access";
#      auth_basic_user_file /etc/nginx/htpasswd.elk;
#      proxy_pass http://es03:9200/;
#      proxy_redirect off;
#      proxy_buffering off;
#      proxy_http_version 1.1;
#      proxy_set_header Connection "Keep-Alive";
#      proxy_set_header Proxy-Connection "Keep-Alive";
#    }

#    location /kibana {
#      #auth_basic "Restricted Access";
#      #auth_basic_user_file /etc/nginx/htpasswd.elk;
#      proxy_pass http://kibana:5601/kibana/;
#    }

#    location ~ /kibana/(?<kibana_uri>.*) {
#      proxy_pass http://kibana:5601/kibana/$kibana_uri;
#      proxy_set_header Authorization "Basic *****";
#      proxy_set_header X-Forwarded-User $http_x_forwarded_for;
#      proxy_buffering off;
#    #  rewrite /login http://kibana:4180/oauth2/sign_in redirect;
#    }

    location /kibana {
        proxy_pass http://kibana:5601/;
        rewrite /kibana/(.*) /$1 break;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
#      proxy_pass http://kibana:5601;
#      proxy_redirect off;
#      proxy_buffering off;
#      proxy_http_version 1.1;
#      proxy_set_header X-Forwarded-User $http_x_forwarded_for;
#      proxy_set_header Connection "Keep-Alive";
#      proxy_set_header Proxy-Connection "Keep-Alive";
    }

#    location /kibana {
#      proxy_pass http://kibana:5601;
#      proxy_http_version 1.1;
#      proxy_set_header Upgrade $http_upgrade;
#      proxy_set_header Connection "upgrade";
#      proxy_set_header Host $host;
#      proxy_set_header X-Real-IP $remote_addr;
#      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#      proxy_set_header X-Forwarded-Proto $scheme;
#      proxy_set_header X-Forwarded-Host $host;
#      proxy_set_header X-Forwarded-Port $server_port;
#      proxy_cache_bypass $http_upgrade;
#    }

#    location /kibana {
#        proxy_pass http://kibana:5601;
#        proxy_http_version 1.1;
#        proxy_set_header Upgrade $http_upgrade;
#        proxy_set_header Connection 'upgrade';
#        proxy_set_header Host $host;
#        proxy_cache_bypass $http_upgrade;
#    }

#    location /kibana {
#      proxy_set_header Host http://kibana:5601/kibana;
#      proxy_set_header X-Real-IP $remote_addr;
#      proxy_http_version 1.1;
#      proxy_set_header Connection "Keep-Alive";
#      proxy_set_header Proxy-Connection "Keep-Alive";
#      proxy_set_header Authorization "";
#      proxy_pass http://kibana:5601/kibana;
#      proxy_redirect http://kibana:5601/kibana/ kibana/;
#    }
#
#    location ~ (/app|/translations|/node_modules|/built_assets/|/bundles|/es_admin|/plugins|/api|/ui|/elasticsearch|/spaces/enter) {
#      proxy_pass          http://kibana:5601/kibana;
#      proxy_set_header    Host $host;
#      proxy_set_header    X-Real-IP $remote_addr;
#      proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
#      proxy_set_header    X-Forwarded-Proto $scheme;
#      proxy_set_header    X-Forwarded-Host $http_host;
#      proxy_set_header    Authorization "";
#      proxy_hide_header   Authorization;
#     }

#  set $proxy_pass_url http://kibana:5601;

#  location /kibana {
#    proxy_set_header Host $proxy_pass_url;
#    proxy_set_header X-Real-IP $remote_addr;

##    proxy_http_version 1.1;
#    proxy_set_header Connection "Keep-Alive";
#    proxy_set_header Proxy-Connection "Keep-Alive";
#    proxy_set_header Authorization "";

#    proxy_pass $proxy_pass_url/_plugin/kibana/;
#    proxy_redirect $proxy_pass_url/_plugin/kibana/ http://kibana/kibana/;
 # }


#  location ~ (/app/kibana|/app/timelion|/bundles|/es_admin|/plugins|/api|/ui|/elasticsearch) {
#         proxy_pass          $proxy_pass_url;
#         proxy_set_header    Host $host;
#         proxy_set_header    X-Real-IP $remote_addr;
#         proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header    X-Forwarded-Proto $scheme;
#         proxy_set_header    X-Forwarded-Host $http_host;
#         proxy_set_header    Authorization "";
#         proxy_hide_header   Authorization;
#    }

    location /portainer {
      #auth_basic "Restricted Access";
      #auth_basic_user_file /etc/nginx/htpasswd.elk;
      proxy_pass http://portainer;
      #rewrite              /portainer/(.*) /$1 break;
      proxy_http_version   1.1;
      proxy_set_header     Connection "";
      proxy_redirect       off;
      proxy_set_header     Host $host;
      proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
}


}


